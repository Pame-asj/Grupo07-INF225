{% extends 'base_docente.html' %}

{% block navegacion %}
<li class="nav-item"><a class="nav-link" href="{% url 'docente_index' %}">Inicio</a></li>
<li class="nav-item"><a class="nav-link" href="{% url 'listar_ensayos' %}">Gestionar Ensayos</a></li>
<li class="nav-item"><a class="nav-link" href="{% url 'resultados_docente' %}">Resultados</a></li>
<li class="nav-item"><a class="nav-link" href="{% url 'listar_preguntas' %}">Banco de Preguntas</a></li>
<li class="nav-item"><a class="nav-link active" href="{% url 'graficos_docente' %}">Gráficos</a></li>
{% endblock %}

{% block cuenta-atras %}
<li class="nav-item"><a class="nav-link" href="{% url 'cuenta_docente' %}">Cuenta</a></li>
<li class="nav-item"><a href="{% url 'logout' %}" class="nav-link">Cerrar sesión</a></li>
{% endblock %}

{% block content %}
<h2 class="mb-4">Gráficos por etiquetas</h2>

<form method="get" class="mb-3">
  <div class="mb-2"><strong>Etiquetas</strong></div>
  <div class="d-flex flex-wrap gap-3">
    {% for tag in tags %}
      <div class="form-check">
        <input class="form-check-input" type="checkbox" name="tags" id="tag{{ tag.id }}" value="{{ tag.id }}"
               {% if tag.id in selected_tag_ids %}checked{% endif %}>
        <label class="form-check-label" for="tag{{ tag.id }}">{{ tag.name }}</label>
      </div>
    {% empty %}
      <p>No hay etiquetas creadas aún.</p>
    {% endfor %}
  </div>
  <div class="mt-3 d-flex gap-2">
    <button type="submit" class="btn btn-primary">Aplicar filtros</button>
    <a href="{% url 'graficos_docente' %}" class="btn btn-secondary">Limpiar</a>
  </div>
</form>

{% if data_labels and total_global %}
  <div class="mb-3">
    <canvas id="chartEtiquetas"></canvas>
  </div>

  <table class="table table-bordered">
    <thead>
      <tr>
        <th>Etiqueta</th>
        <th>Correctas</th>
        <th>Incorrectas</th>
        <th>Total</th>
      </tr>
    </thead>
    <tbody>
  {% for row in agg %}
    <tr>
      <td>{{ row.name }}</td>
      <td>{{ row.correctas }}</td>
      <td>{{ row.incorrectas }}</td>
      <td>{{ row.total }}</td>
    </tr>
  {% endfor %}
</tbody>
  </table>

{% else %}
  <div class="alert alert-info mt-3">
    No hay datos para los filtros seleccionados. Ajusta las etiquetas o carga datos de prueba.
  </div>
{% endif %}

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  (function() {
    const labels = {{ data_labels|safe }};
    const correctas = {{ data_correctas|safe }};
    const incorrectas = {{ data_incorrectas|safe }};

    if (labels.length > 0) {
      const ctx = document.getElementById('chartEtiquetas').getContext('2d');
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [
            { label: 'Correctas', data: correctas },
            { label: 'Incorrectas', data: incorrectas }
          ]
        },
        options: {
          responsive: true,
          scales: {
            x: { stacked: true },
            y: { stacked: true, beginAtZero: true }
          }
        }
      });
    }
  })();
</script>
{% endblock %}
